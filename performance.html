
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />
<meta property="og:title" content="Performance Tips" />
<meta property="og:type" content="website" />
<meta property="og:url" content="performance.html" />
<meta property="og:site_name" content="LensKit" />
<meta property="og:description" content="LensKit strives to provide pretty good performance (in terms of computation speed), but sometimes it needs a little nudging. Quick Tips: Use Conda-based Python, with tbb installed., When using MKL,..." />
<meta property="og:image:width" content="1146" />
<meta property="og:image:height" content="600" />
<meta property="og:image" content="/_images/social_previews/summary_performance_cd839115.png" />
<meta property="og:image:alt" content="LensKit strives to provide pretty good performance (in terms of computation speed), but sometimes it needs a little nudging. Quick Tips: Use Conda-based Pyth..." />
<meta name="description" content="LensKit strives to provide pretty good performance (in terms of computation speed), but sometimes it needs a little nudging. Quick Tips: Use Conda-based Python, with tbb installed., When using MKL,..." />
<meta name="twitter:card" content="summary_large_image" />

    <title>Performance Tips &#8212; LensKit 0.15.0.dev951+g46053981 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=4b41acf8"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'performance';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.15.4';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://lkpy.lenskit.org/versions.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = '2024.0dev';
        DOCUMENTATION_OPTIONS.show_version_warning_banner = false;
        </script>
    <link rel="canonical" href="https://lkpy.lenskit.org/en/latest/performance.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Errors and Diagnostics" href="diagnostics.html" />
    <link rel="prev" title="Hierarchical Poisson Factorization" href="addons/hpf.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/LKLogo2.png" class="logo__image only-light" alt="LensKit 0.15.0.dev951+g46053981 documentation - Home"/>
    <script>document.write(`<img src="_static/LKLogo2.png" class="logo__image only-dark" alt="LensKit 0.15.0.dev951+g46053981 documentation - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    LensKit
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="install.html">Install LensKit</a></li>
<li class="toctree-l1"><a class="reference internal" href="GettingStarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Examples</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="releases/index.html">Release Notes</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="releases/2024.html">2024 Releases</a></li>
<li class="toctree-l2"><a class="reference external" href="https://github.com/lenskit/lkpy/releases">Older Versions</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Running Experiments</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="data.html">Data Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="crossfold.html">Splitting Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="batch.html">Batch-Running Recommenders</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="evaluation/index.html">Evaluating Recommender Output</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="evaluation/predict-metrics.html">Prediction Accuracy Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="evaluation/topn-metrics.html">Top-<em>N</em> Evaluation</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="documenting.html">Documenting Experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="parallel.html">Parallel Execution</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Algorithms</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="interfaces.html">Algorithm Interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithms.html">Algorithm Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="basic.html">Basic and Utility Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="ranking.html">Ranking Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="bias.html">Bias</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="knn.html">k-NN Collaborative Filtering</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="mf.html">Classic Matrix Factorization</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="addons/index.html">Add-On Algorithms</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="addons/implicit.html">Implicit wrappers</a></li>
<li class="toctree-l2"><a class="reference internal" href="addons/hpf.html">Poisson factorization</a></li>
<li class="toctree-l2"><a class="reference external" href="https://lkpy.lenskit.org/projects/lenskit-tf/">TensorFlow algorithms</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Tips and Tricks</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Performance Tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="diagnostics.html">Errors and Diagnostics</a></li>
<li class="toctree-l1"><a class="reference internal" href="impl-tips.html">Algorithm Implementation Tips</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Configuration and Internals</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="util.html">Utility Functions</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="math.html">Math utilities</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="internals.html">LensKit Internals</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Links</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="references.html">References</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
      
        <div class="header-article-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-2"
      type="button"
      class="version-switcher__button btn btn-sm dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-2"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-2"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-2">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Performance Tips</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quick-tips">Quick Tips</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#controlling-parallelism">Controlling Parallelism</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#other-notes">Other Notes</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="performance-tips">
<h1>Performance Tips<a class="headerlink" href="#performance-tips" title="Link to this heading">#</a></h1>
<p>LensKit strives to provide pretty good performance (in terms of computation speed), but
sometimes it needs a little nudging.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you are implementing an algorithm, see the <a class="reference external" href="impl-tips.html">implementation tips</a> for information
on good performance.</p>
</div>
<section id="quick-tips">
<h2>Quick Tips<a class="headerlink" href="#quick-tips" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Use Conda-based Python, with <code class="docutils literal notranslate"><span class="pre">tbb</span></code> installed.</p></li>
<li><p>When using MKL, set the <code class="docutils literal notranslate"><span class="pre">MKL_THREADING_LAYER</span></code> environment variable to <code class="docutils literal notranslate"><span class="pre">tbb</span></code>, so both
MKL and LensKit will use TBB and can coordinate their thread pools.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">LK_NUM_PROCS</span></code> if you want to control LensKit’s batch prediction and recommendation
parallelism, and <code class="docutils literal notranslate"><span class="pre">NUMBA_NUM_THREADS</span></code> to control its model training parallelism.</p></li>
</ul>
<p>We generally find the best performance using MKL with TBB throughout the stack on Intel
processors.  If both LensKit’s Numba-accelerated code and MKL are using TBB, they will
coordinate their thread pools to coordinate threading levels.</p>
<p>If you are <strong>not</strong> using MKL (Apple Silicon, maybe also AMD processors), we recommend
controlling your BLAS parallelism.  For OpenBLAS, how you control this depends on how
OpenBLAS was built, whether Numba is using OpenMP or TBB, and whether you are training
or evaluating the model.</p>
<p>When LensKit starts (usually at model training time), it will check your runtime environment
and log warning messages if it detects problems.  During evaluation, it also makes a
best-effort attempt, through <a class="reference external" href="https://github.com/joblib/threadpoolctl">threadpoolctl</a>, to disable nested parallelism when running
a parallel evaluation.</p>
</section>
<section id="controlling-parallelism">
<h2>Controlling Parallelism<a class="headerlink" href="#controlling-parallelism" title="Link to this heading">#</a></h2>
<p>LensKit has two forms of parallelism.  Algorithm training processes can be parallelized
through a number of mechanisms:</p>
<ul class="simple">
<li><p>Our own parallel code uses Numba, which in turn uses TBB (preferred) or OpenMP.  The
thread count is controlled by <code class="docutils literal notranslate"><span class="pre">NUMBA_NUM_THREADS</span></code>.</p></li>
<li><p>The BLAS library may parallelize underlying operations using its threading library.
This is usually OpenMP; MKL also supports TBB, but unlike Numba, it defaults to
OpenMP even if TBB is available.</p></li>
<li><p>Underlying libraries such as TensorFlow and scikit-learn may provide their
own parallelism.</p></li>
</ul>
<p>The LensKit <a class="reference external" href="batch.html">batch functions</a> use Python <code class="docutils literal notranslate"><span class="pre">multiprocessing</span></code>, and their concurrency
level is controlled by the <code class="docutils literal notranslate"><span class="pre">LK_NUM_PROCS</span></code> environment variable.  The default number
of processes is one-half the number of cores as reported by <a class="reference external" href="https://docs.python.org/3/library/multiprocessing.html#multiprocessing.cpu_count" title="(in Python v3.12)"><code class="xref py py-func docutils literal notranslate"><span class="pre">multiprocessing.cpu_count()</span></code></a>.
The batch functions also set the thread count for some libraries within the worker
procesess, to prevent over-subscribing the CPU.  Right now, the worker will configure
Numba and MKL.  In the rest of this section, this will be referred to as the ‘inner
thread count’.</p>
<p>The thread count logic is controlled by <code class="xref py py-func docutils literal notranslate"><span class="pre">lenskit.util.parallel.proc_count()</span></code>,
and works as follows:</p>
<ul class="simple">
<li><p>If <code class="docutils literal notranslate"><span class="pre">LK_NUM_PROCS</span></code> is an integer, the batch functions will use the specified number
of processes, and with 1 inner thread.</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">LK_NUM_PROCS</span></code> is a comma-separated pair of integers (e.g. <code class="docutils literal notranslate"><span class="pre">8,4</span></code>), the batch
functions will use the first number for the process count and the second number as
the inner thread count.  This <strong>overrides</strong> <code class="docutils literal notranslate"><span class="pre">NUMBA_NUM_THREADS</span></code>, unless it is larger
than <code class="docutils literal notranslate"><span class="pre">NUMBA_NUM_THREADS</span></code>.</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">LK_NUM_PROCS</span></code> is not set, the batch functions use half the number of cores as
the process count and 2 as the inner thread count (unless <code class="docutils literal notranslate"><span class="pre">NUMBA_NUM_THREADS</span></code> is
set to 1 in the environment).</p></li>
</ul>
</section>
<section id="other-notes">
<h2>Other Notes<a class="headerlink" href="#other-notes" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Batch parallelism <strong>disables</strong> TensorFlow GPUs in the worker threads.  This is fine,
because GPUs are most useful for model training; multiple worker processes competing
for the GPU causes problems.</p></li>
</ul>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="addons/hpf.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Hierarchical Poisson Factorization</p>
      </div>
    </a>
    <a class="right-next"
       href="diagnostics.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Errors and Diagnostics</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quick-tips">Quick Tips</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#controlling-parallelism">Controlling Parallelism</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#other-notes">Other Notes</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Michael D. Ekstrand
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2018–2024 Drexel University, Boise State University, and collaborators.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>