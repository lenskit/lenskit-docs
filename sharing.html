

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Model Sharing &mdash; LensKit 0.11.0 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
        <script async="async" src="https://assets.readthedocs.org/static/javascript/readthedocs-doc-embed.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Parallel Execution" href="parallel.html" />
    <link rel="prev" title="LensKit Internals" href="internals.html" /> 

<!-- RTD Extra Head -->

<!-- 
Always link to the latest version, as canonical.
http://docs.readthedocs.org/en/latest/canonical.html
-->
<link rel="canonical" href="https://lkpy.readthedocs.io/en/stable/sharing.html" />

<link rel="stylesheet" href="https://assets.readthedocs.org/static/css/readthedocs-doc-embed.css" type="text/css" />

<script type="application/json" id="READTHEDOCS_DATA">{"ad_free": false, "api_host": "https://readthedocs.org", "build_date": "2020-11-13T20:18:15Z", "builder": "sphinx", "canonical_url": "https://lkpy.readthedocs.io/en/stable/", "commit": "7688094a", "docroot": "/doc/", "features": {"docsearch_disabled": false}, "global_analytics_code": "UA-17997319-1", "language": "en", "page": "sharing", "programming_language": "py", "project": "lkpy", "proxied_api_host": "/_", "source_suffix": ".rst", "subprojects": {}, "theme": "sphinx_rtd_theme", "user_analytics_code": "", "version": "0.11.1"}</script>

<!--
Using this variable directly instead of using `JSON.parse` is deprecated.
The READTHEDOCS_DATA global variable will be removed in the future.
-->
<script type="text/javascript">
READTHEDOCS_DATA = JSON.parse(document.getElementById('READTHEDOCS_DATA').innerHTML);
</script>

<script type="text/javascript" src="https://assets.readthedocs.org/static/javascript/readthedocs-analytics.js" async="async"></script>

<!-- end RTD <extrahead> -->
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> LensKit
          

          
          </a>

          
            
            
            
              <div class="version">
                0.11.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="install.html">Install LensKit</a></li>
<li class="toctree-l1"><a class="reference internal" href="GettingStarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/lenskit/lkpy/releases">Release Notes</a></li>
</ul>
<p class="caption"><span class="caption-text">Running Experiments</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="datasets.html">Loading Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="crossfold.html">Splitting Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="batch.html">Batch-Running Recommenders</a></li>
<li class="toctree-l1"><a class="reference internal" href="evaluation/index.html">Evaluating Recommender Output</a></li>
</ul>
<p class="caption"><span class="caption-text">Algorithms</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="interfaces.html">Algorithm Interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithms.html">Algorithm Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="basic.html">Basic and Utility Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="bias.html">Bias</a></li>
<li class="toctree-l1"><a class="reference internal" href="knn.html">k-NN Collaborative Filtering</a></li>
<li class="toctree-l1"><a class="reference internal" href="mf.html">Classic Matrix Factorization</a></li>
<li class="toctree-l1"><a class="reference internal" href="tf.html">TensorFlow Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="hpf.html">Hierarchical Poisson Factorization</a></li>
<li class="toctree-l1"><a class="reference internal" href="implicit.html">Implicit</a></li>
</ul>
<p class="caption"><span class="caption-text">Tips and Tricks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="performance.html">Performance Tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="diagnostics.html">Errors and Diagnostics</a></li>
<li class="toctree-l1"><a class="reference internal" href="impl-tips.html">Algorithm Implementation Tips</a></li>
</ul>
<p class="caption"><span class="caption-text">Configuration and Internals</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="util.html">Utility Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="random.html">Random Number Generation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="internals.html">LensKit Internals</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Model Sharing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#sharing-mode">Sharing Mode</a></li>
<li class="toctree-l3"><a class="reference internal" href="#persistence-api">Persistence API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="parallel.html">Parallel Execution</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">LensKit</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="internals.html">LensKit Internals</a> &raquo;</li>
        
      <li>Model Sharing</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/lenskit/lkpy/blob/0.11.1/doc/sharing.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="module-lenskit.sharing">
<span id="model-sharing"></span><h1>Model Sharing<a class="headerlink" href="#module-lenskit.sharing" title="Permalink to this headline">¶</a></h1>
<p>The <a class="reference internal" href="#module-lenskit.sharing" title="lenskit.sharing"><code class="xref py py-mod docutils literal notranslate"><span class="pre">lenskit.sharing</span></code></a> module provides utilities for managing models and sharing them
between processes, particularly for the  multiprocessing in <a class="reference internal" href="batch.html#module-lenskit.batch" title="lenskit.batch"><code class="xref py py-mod docutils literal notranslate"><span class="pre">lenskit.batch</span></code></a>.</p>
<div class="section" id="sharing-mode">
<h2>Sharing Mode<a class="headerlink" href="#sharing-mode" title="Permalink to this headline">¶</a></h2>
<p>The only piece <strong>algorithm developers</strong> usually need to directly handle is the concept of
‘sharing mode’ when implementing custom pickling logic.  To save space, it is reasonable to
exclude intermediate data structures, such as caches or inverse indexes, from the pickled
representation of an algorithm, and reconstruct them when the model is loaded.</p>
<p>However, LensKit’s multi-process sharing <em>also</em> uses pickling to capture the object state
while using shared memory for <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v1.19)"><code class="xref py py-class docutils literal notranslate"><span class="pre">numpy.ndarray</span></code></a> objects.  In these cases, the structures
should be pickled, so they can be shared between model instances.</p>
<p>To support this, we have the concept of <em>sharing mode</em>.  Code that excludes objects when
pickling should call <a class="reference internal" href="#lenskit.sharing.in_share_context" title="lenskit.sharing.in_share_context"><code class="xref py py-func docutils literal notranslate"><span class="pre">in_share_context()</span></code></a> to determine if that exclusion should
actually happen.</p>
<dl class="py function">
<dt id="lenskit.sharing.in_share_context">
<code class="sig-prename descclassname">lenskit.sharing.</code><code class="sig-name descname">in_share_context</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#lenskit.sharing.in_share_context" title="Permalink to this definition">¶</a></dt>
<dd><p>Query whether sharing mode is active.  If <code class="docutils literal notranslate"><span class="pre">True</span></code>, we are currently in a
<a class="reference internal" href="#lenskit.sharing.sharing_mode" title="lenskit.sharing.sharing_mode"><code class="xref py py-func docutils literal notranslate"><span class="pre">sharing_mode()</span></code></a> context, which means model pickling will be used for
cross-process sharing.</p>
</dd></dl>

<dl class="py function">
<dt id="lenskit.sharing.sharing_mode">
<code class="sig-prename descclassname">lenskit.sharing.</code><code class="sig-name descname">sharing_mode</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#lenskit.sharing.sharing_mode" title="Permalink to this definition">¶</a></dt>
<dd><p>Context manager to tell models that pickling will be used for cross-process
sharing, not model persistence.</p>
</dd></dl>

</div>
<div class="section" id="persistence-api">
<h2>Persistence API<a class="headerlink" href="#persistence-api" title="Permalink to this headline">¶</a></h2>
<p>These functions are used for internal LensKit infrastructure code to persist models into
shared memory for parallel processing.</p>
<dl class="py function">
<dt id="lenskit.sharing.persist">
<code class="sig-prename descclassname">lenskit.sharing.</code><code class="sig-name descname">persist</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">model</span></em>, <em class="sig-param"><span class="o">*</span></em>, <em class="sig-param"><span class="n">method</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="headerlink" href="#lenskit.sharing.persist" title="Permalink to this definition">¶</a></dt>
<dd><p>Persist a model for cross-process sharing.</p>
<p>This will return a persiste dmodel that can be used to reconstruct the model
in a worker process (using <code class="xref py py-func docutils literal notranslate"><span class="pre">reconstruct()</span></code>).</p>
<p>If no method is provided, this function automatically selects a model persistence
strategy from the the following, in order:</p>
<ol class="arabic simple">
<li><p>If <cite>LK_TEMP_DIR</cite> is set, use <code class="xref py py-mod docutils literal notranslate"><span class="pre">binpickle</span></code> in shareable mode to save
the object into the LensKit temporary directory.</p></li>
<li><p>If <a class="reference external" href="https://docs.python.org/3/library/multiprocessing.shared_memory.html#module-multiprocessing.shared_memory" title="(in Python v3.9)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">multiprocessing.shared_memory</span></code></a> is available, use <a class="reference external" href="https://docs.python.org/3/library/pickle.html#module-pickle" title="(in Python v3.9)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pickle</span></code></a>
to save the model, placing the buffers into shared memory blocks.</p></li>
<li><p>Otherwise, use <code class="xref py py-mod docutils literal notranslate"><span class="pre">binpickle</span></code> in shareable mode to save the object
into the system temporary directory.</p></li>
</ol>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>model</strong> (<em>obj</em>) – The model to persist.</p></li>
<li><p><strong>method</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)"><em>str</em></a><em> or </em><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.9)"><em>None</em></a>) – The method to use.  Can be one of <code class="docutils literal notranslate"><span class="pre">binpickle</span></code> or <code class="docutils literal notranslate"><span class="pre">shm</span></code>.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>The persisted object.</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p><a class="reference internal" href="#lenskit.sharing.PersistedModel" title="lenskit.sharing.PersistedModel">PersistedModel</a></p>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt id="lenskit.sharing.PersistedModel">
<em class="property">class </em><code class="sig-prename descclassname">lenskit.sharing.</code><code class="sig-name descname">PersistedModel</code><a class="headerlink" href="#lenskit.sharing.PersistedModel" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference external" href="https://docs.python.org/3/library/abc.html#abc.ABC" title="(in Python v3.9)"><code class="xref py py-class docutils literal notranslate"><span class="pre">abc.ABC</span></code></a></p>
<p>A persisted model for inter-process model sharing.</p>
<p>These objects can be pickled for transmission to a worker process.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Subclasses need to override the pickling protocol to implement the
proper pickling implementation.</p>
</div>
<dl class="py method">
<dt id="lenskit.sharing.PersistedModel.get">
<em class="property">abstract </em><code class="sig-name descname">get</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#lenskit.sharing.PersistedModel.get" title="Permalink to this definition">¶</a></dt>
<dd><p>Get the persisted model, reconstructing it if necessary.</p>
</dd></dl>

<dl class="py method">
<dt id="lenskit.sharing.PersistedModel.close">
<em class="property">abstract </em><code class="sig-name descname">close</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#lenskit.sharing.PersistedModel.close" title="Permalink to this definition">¶</a></dt>
<dd><p>Release the persisted model resources.  Should only be called in the
parent process (will do nothing in a child process).</p>
</dd></dl>

<dl class="py method">
<dt id="lenskit.sharing.PersistedModel.transfer">
<code class="sig-name descname">transfer</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#lenskit.sharing.PersistedModel.transfer" title="Permalink to this definition">¶</a></dt>
<dd><p>Mark an object for ownership transfer.  This object, when pickled, will
unpickle into an owning model that frees resources when closed. Used to
transfer ownership of shared memory resources from child processes to
parent processes.  Such an object should only be unpickled once.</p>
<p>The default implementation sets the <code class="docutils literal notranslate"><span class="pre">is_owner</span></code> attribute to <code class="docutils literal notranslate"><span class="pre">'transfer'</span></code>.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">self</span></code> (for convenience)</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="parallel.html" class="btn btn-neutral float-right" title="Parallel Execution" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="internals.html" class="btn btn-neutral float-left" title="LensKit Internals" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2018–2019 Boise State University
      <span class="commit">
        
        Revision <code>7688094a</code>.
      </span>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
<p>This material is based upon work supported by the National Science Foundation under
Grant No. <a href="https://md.ekstrandom.net/research/career">IIS 17-51278</a>. Any
opinions, findings, and conclusions or recommendations expressed in this material
are those of the author(s) and do not necessarily reflect the views of the
National Science Foundation.  This page has not been approved by
Boise State University and does not reflect official university positions.</p>
<script data-goatcounter="https://lenskit.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>


</footer>

        </div>
      </div>

    </section>

  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      v: 0.11.1
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Versions</dt>
        
          <dd><a href="/en/latest/">latest</a></dd>
        
          <dd><a href="/en/stable/">stable</a></dd>
        
          <dd><a href="/en/0.11.1/">0.11.1</a></dd>
        
          <dd><a href="/en/0.11.0/">0.11.0</a></dd>
        
          <dd><a href="/en/0.10.1/">0.10.1</a></dd>
        
          <dd><a href="/en/0.10.0/">0.10.0</a></dd>
        
          <dd><a href="/en/0.9.0/">0.9.0</a></dd>
        
          <dd><a href="/en/0.8.4/">0.8.4</a></dd>
        
          <dd><a href="/en/0.8.1/">0.8.1</a></dd>
        
          <dd><a href="/en/0.8.0/">0.8.0</a></dd>
        
          <dd><a href="/en/0.7.0/">0.7.0</a></dd>
        
          <dd><a href="/en/0.6.1/">0.6.1</a></dd>
        
          <dd><a href="/en/0.6.0/">0.6.0</a></dd>
        
          <dd><a href="/en/0.5.0/">0.5.0</a></dd>
        
          <dd><a href="/en/0.3.0/">0.3.0</a></dd>
        
          <dd><a href="/en/0.2.0/">0.2.0</a></dd>
        
          <dd><a href="/en/0.1.0/">0.1.0</a></dd>
        
      </dl>
      <dl>
        <dt>Downloads</dt>
        
      </dl>
      <dl>
        
        <dt>On Read the Docs</dt>
          <dd>
            <a href="//readthedocs.org/projects/lkpy/?fromdocs=lkpy">Project Home</a>
          </dd>
          <dd>
            <a href="//readthedocs.org/builds/lkpy/?fromdocs=lkpy">Builds</a>
          </dd>
      </dl>
    </div>
  </div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
   

</body>
</html>